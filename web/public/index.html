<!DOCTYPE html>
<html>
<head>
<title>Spotter</title>
	<style>
	ul {
		position: sticky;
	    list-style-type: none;
	    margin: 0;
	    padding: 0;
	    overflow: hidden;
	    background-color: #333;
	}
		li {
		    float: left;
		}

		li a {
		    display: block;
		    color: #f2f2f2;
		    text-align: center;
		    padding: 14px 16px;
		    font-size: 17px;
		    text-decoration: none;
		}

		li a:hover:not(.active) {
		    background-color: #111;
		}

		.active {
   			background-color: #4d94ff;
		}

		h1 {
			text-align: center;
		}

		h3 {
			font-size: 20px;
		}

		p.ex1 {
			font-size: 20px;
		}

		p.ex2 {
			font-size: 15px;
		}

		#map {
			float: left;
			width: 100%;
			height: 600px;
			background-color: grey;
		}

		table th, td{
			float: right;
			border: 1px solid black;
	  	  	border-collapse: collapse;
		}

		th, td {
		    padding: 2px;
		    text-align: left;
		    font-size: 7px;
		}

		#destination {
			float: left;
			width: 40%;
			height: 100px;
			font-size: 10px;
		}

      #pac-input {
        background-color: #fff;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        margin-left: 12px;
        padding: 0 11px 0 13px;
        text-overflow: ellipsis;
        width: 400px;
      }

      #pac-input:focus {
        border-color: #4d90fe;
      }


    </style>
    
    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-database.js"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="markerclusterer.js"></script>
    
    <script>
        var config = {
            apiKey: "AIzaSyBD8z7IEJtKXhRQAe37Piad7moHD1JBBCY",
            authDomain: "spotter-6ba86.firebaseapp.com",
            databaseURL: "https://spotter-6ba86.firebaseio.com",
            projectId: "spotter-6ba86",
            storageBucket: "spotter-6ba86.appspot.com",
            messagingSenderId: "242336049467"
          };
        firebase.initializeApp(config);
        var database = firebase.database();
        var data = {};
        var markers = {};
        var timer;
        var map;
        
        function initAutocomplete() 
        {
            getAllData();
            map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 13,
                    center: {lat: 40.425, lng: -86.929},
                    mapTypeId: 'roadmap'
                });

            var input = document.getElementById('pac-input');
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);

            autocomplete.addListener('place_changed', function() {
                
                var place = autocomplete.getPlace();
                 if (!place.geometry) 
                 {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                 }

                // If the place has a geometry, then present it on a map.
                if (place.geometry.viewport) 
                {
                    map.fitBounds(place.geometry.viewport);
                }
                else
                {
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);  // Why 17? Because it looks good.
                }
                
                var placeMarker =  new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
            });    
            });
//            
        }

        
        function addAnnotation()
        {
            var marker;
            var count = 0;
            for (var i in data)
            {
                markers[count] = new google.maps.Marker({
                position: {lat: data[i]["Latitude"], lng: data[i]["Longitude"]},
                map: map
            });    
                count++;
            }
            var markerCluster = new MarkerClusterer(map, markers, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
                                                                  });
      
        }

        function getData(id, path)
        {
              firebase.database().ref(path).once('value').then(
                    function(snapshot)
                    {
                         document.getElementById(id).innerHTML += (snapshot.val()); 
                    }
                );
        }
        function getAllData()
        {
            firebase.database().ref('/').once('value', 
                function(snapshot) 
                {
                    snapshot.forEach(
                        function(childSnapshot) 
                        {
                            var record = childSnapshot.key
                            var buff = {};
                            childSnapshot.forEach(
                                function(childSnapshot)
                                {
                                    var key = childSnapshot.key;
                                    var val = childSnapshot.val();
                                    buff[key] = val;
    //                                        window.alert(key + ' : ' + val);    
                                }
                            );

                            data[record] = buff;
                        }
                    );
                    addAnnotation();
                    timer = setTimeout(getAllData, 5000);
                }
            );
            
        }
        function closing()
        {
            console.log("closing");
            firebase.app().delete();
            clearTimeout(timer);
        }
    </script>
    <script async defer 
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSrts5bW5PA9cFy9McRvFwfraVkwMeaT4&libraries=places&callback=initAutocomplete">
    </script>
	
</head>
<body onunload="closing()">
    
	<h1>Let's Park!</h1>
	<ul>
		<li><a class="active" href="/">Home</a></li>
		<li><a href="/getLocation.html">Contribute</a></li>
		<li><a href="inputRank">Contribution Ranking</a></li>
		<li><a href="/about">About</a></li>
	</ul>

	<h3>Avaiable Spot</h3>
	<input id="pac-input" class="controls" type="text" placeholder="Search Box">
	<div id="map"></div>
	

<!--
	<div id="destination" >
		<p class="ex1">Where are you going?</p>
		<p class="ex2">example: "lawson"</p>
		<input type="search" name="destination">
	</div>
-->

</body>
</html>
